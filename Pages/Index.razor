@page "/"
@using BlazorBootstrap
@using PadelTournamentManager.Models.Enums

<!-- Fullscreen, oversized, rotated üéæ background -->
<div class="bg-emoji-fixed" aria-hidden="true"></div>

<div class="container py-4">
<div class="row g-4">
@if (!ShowMatches)
{
    <div class="col-lg-6">
        <Card Class="h-100 border-0 shadow-sm rounded-4 bg-primary-subtle">
            <CardBody Class="text-center p-4">
                <CardTitle Class="mb-3 fw-semibold text-primary-emphasis">üèÜ Tournament type</CardTitle>

                <div class="d-inline-block text-start">
                    <div class="form-check mb-2">
                        <RadioInput Name="TournamentType" Label="Americano" @bind-Value="IsAmericano" />
                    </div>
                    <div class="form-check">
                        <RadioInput Name="TournamentType" Label="Mexicano" @bind-Value="IsMexicano" />
                    </div>
                </div>
            </CardBody>
        </Card>
    </div>

    <!-- Result sorting -->
    <div class="col-lg-6">
        <Card Class="h-100 border-0 shadow-sm rounded-4 bg-info-subtle">
            <CardBody Class="text-center p-4">
                <CardTitle Class="mb-3 fw-semibold text-info-emphasis">üìä Result sorting</CardTitle>

                <div class="d-inline-block text-start">
                    <div class="form-check mb-2">
                        <RadioInput Name="ResultSorting" Label="Points then wins" @bind-Value="IsPointsThenWins" />
                    </div>
                    <div class="form-check">
                        <RadioInput Name="ResultSorting" Label="Wins then points" @bind-Value="IsWinsThenPoints" />
                    </div>
                </div>
            </CardBody>
        </Card>
    </div>

    <div class="col-lg-6">
        <Card Class="h-100 border-0 shadow-sm rounded-4 bg-warning-subtle">
            <CardBody Class="text-center p-4">
                <CardTitle Class="mb-3 fw-semibold text-warning-emphasis">üéØ Scoring</CardTitle>

                <div class="d-inline-block text-start" style="min-width:320px; max-width:460px;">

                    <div class="form-check mb-2">
                        <RadioInput Name="ScoringMode"
                                    Label="Play points or games"
                                    @bind-Value="IsPlayPointsOrGames" />
                    </div>

                    <div class="d-flex align-items-center gap-2">
                        <div class="form-check m-0">
                            <RadioInput Name="ScoringMode"
                                        Label="Play to"
                                        @bind-Value="IsPlayToPoints" />
                        </div>

                        <InputNumber @bind-Value="Game.ToPoints"
                                     class="form-control form-control-sm w-auto"
                                     min="1" max="99"
                                     disabled="@(!IsPlayToPoints)" />
                        <span>points</span>
                    </div>
                </div>
            </CardBody>
        </Card>
    </div>


    <div class="col-lg-6">
        <Card Class="h-100 border-0 shadow-sm rounded-4 bg-success-subtle">
            <CardBody Class="text-center p-4">
                <CardTitle Class="mb-3 fw-semibold text-success-emphasis">üë• Team format</CardTitle>

                <div class="d-inline-block text-start">
                    <div class="form-check mb-2">
                        <RadioInput Name="TeamFormat" Label="Individually" @bind-Value="IsIndividual" />
                    </div>
                    <div class="form-check">
                        <RadioInput Name="TeamFormat" Label="Team" @bind-Value="IsTeam" />
                    </div>
                </div>
            </CardBody>
        </Card>
    </div>

    <div class="col-lg-6">
        <Card Class="h-100 border-0 shadow-sm rounded-4 bg-light">
            <CardBody Class="text-center p-4">
                <CardTitle class="mb-3 fw-semibold">üéæ Courts</CardTitle>

                <div class="d-flex justify-content-center">
                    <div class="input-group mb-3" style="max-width: 480px;">
                        <TextInput Placeholder="Court name"
                                   @bind-Value="NewCourtName"
                                   OnInput="@((ChangeEventArgs e) => NewCourtName = e?.Value?.ToString() )"
                                   @onkeyup="@(e => OnEnterUp(e, AddCourt) )" />
                        <Button Color="ButtonColor.Secondary" Class="px-4" @onclick="AddCourt">ADD</Button>
                    </div>
                </div>

                <ol class="list-unstyled mb-0 d-inline-block text-start w-100" style="max-width: 560px;">
                    @foreach (var c in Game.Courts)
                    {
                        <li @key="c.Order" class="d-flex align-items-center py-2 border-bottom">

                            @if (c.IsEditing)
                            {
                                <div class="flex-grow-1 me-3">
                                    <TextInput Placeholder="Court name"
                                               @bind-Value="c.EditName"
                                               OnInput="@((ChangeEventArgs e) => c.EditName = e?.Value?.ToString())"
                                               @onkeyup="@(e => OnEnterUp(e, () => SaveCourt(c.Order)))"/>
                                </div>

                                <Button Color="ButtonColor.Secondary" Class="me-2"
                                        Title="Save" @onclick="@(() => SaveCourt(c.Order))">
                                    <Icon Name="IconName.Check2" />
                                </Button>
                                <Button Color="ButtonColor.Link" Class="me-3"
                                        Title="Cancel" @onclick="@(() => CancelEditCourt(c.Order))">
                                    <Icon Name="IconName.XLg" />
                                </Button>
                            }
                            else
                            {
                                <span class="me-2 fw-medium">@c.Order.</span>
                                <span class="flex-grow-1">@c.Name</span>
                                    
                                <Badge Color="BadgeColor.Primary" IndicatorType="BadgeIndicatorType.RoundedPill" Class="me-3">
                                    PADEL
                                </Badge>

                                <Button Color="ButtonColor.Link" Class="me-2"
                                        Title="Edit" @onclick="@(() => EditCourtByOrder(c.Order))">
                                    <Icon Name="IconName.PencilSquare" />
                                </Button>
                            }

                            <Button Color="ButtonColor.Link" Class="text-danger p-0"
                                    Title="Delete" @onclick="@(() => RemoveCourtByOrder(c.Order))">
                                <Icon Name="IconName.TrashFill" />
                            </Button>
                        </li>
                    }
                </ol>
            </CardBody>
        </Card>
    </div>

    <div class="col-lg-6">
        <Card Class="h-100 border-0 shadow-sm rounded-4 bg-secondary-subtle">
            <CardBody Class="text-center p-4">
                <CardTitle class="mb-3 fw-semibold text-secondary-emphasis">üßë‚Äçü§ù‚Äçüßë Players</CardTitle>

                <div class="d-flex justify-content-center">
                    <div class="input-group mb-3" style="max-width: 480px;">
                        <TextInput Placeholder="Player name"
                                   @bind-Value="NewPlayerName"
                                   OnInput="@((ChangeEventArgs e) => NewPlayerName = e?.Value?.ToString() )"
                                   @onkeyup="@(e => OnEnterUp(e, AddPlayer) )" />
                        <Button Color="ButtonColor.Secondary" Class="px-4" @onclick="AddPlayer">ADD</Button>
                    </div>
                </div>

                <ol class="list-unstyled mb-0 d-inline-block text-start w-100" style="max-width: 560px;">
                    @foreach (var p in Game.Players)
                    {
                        <li @key="p.Name" class="d-flex align-items-center py-2 border-bottom">
                            <span class="me-2 fw-medium">@p.Order.</span>

                            @if (p.IsEditing)
                            {
                                <div class="flex-grow-1 me-3">
                                    <TextInput Placeholder="Player name"
                                               @bind-Value="p.EditName"
                                               OnInput="@((ChangeEventArgs e) => p.EditName = e?.Value?.ToString())"
                                               @onkeyup="@(e => OnEnterUp(e, () => SavePlayer(p.Name)))"/>
                                </div>

                                <Button Color="ButtonColor.Secondary" Class="me-2"
                                        Title="Save" @onclick="@(() => SavePlayer(p.Name))">
                                    <Icon Name="IconName.Check2" />
                                </Button>
                                <Button Color="ButtonColor.Link" Class="me-3"
                                        Title="Cancel" @onclick="@(() => CancelEditPlayer(p.Name))">
                                    <Icon Name="IconName.XLg" />
                                </Button>
                            }
                            else
                            {
                                <span class="flex-grow-1">@p.Name</span>

                                <Badge Color="BadgeColor.Secondary"
                                       IndicatorType="BadgeIndicatorType.RoundedPill"
                                       Class="me-3">
                                    PLAYER
                                </Badge>

                                <Button Color="ButtonColor.Link" Class="me-2"
                                        Title="Edit" @onclick="@(() => EditPlayer(p.Name))">
                                    <Icon Name="IconName.PencilSquare" />
                                </Button>
                            }

                            <Button Color="ButtonColor.Link" Class="text-danger p-0"
                                    Title="Delete" @onclick="@(() => RemovePlayerById(p.Name))">
                                <Icon Name="IconName.TrashFill" />
                            </Button>
                        </li>
                    }
                </ol>
            </CardBody>
        </Card>
            
    </div>
}

@if (ShowMatches && Game.Matches.Any())
{
    <div class="row g-4">
        @foreach (var m in Game.Matches)
        {
            <div class="col-lg-6">
                <div class="text-center fw-semibold fs-3 mb-2">@m.CourtName</div>

                <div class="court">
                    <div class="court-grid">
                        <!-- TOP LEFT -->
                        <div class="grid-top-left">
                            @if (Game.TeamFormat == TeamFormat.Pairs)
                            {
                                <div class="pill pill-dark">@m.Team1.Single().Name</div>
                            }
                            else
                            {
                                var names1 = IndividualNames(m.Team1).ToArray();
                                <div class="pill pill-dark pill-sm">@names1[0]</div>
                            }
                        </div>

                        <!-- TOP RIGHT -->
                        <div class="grid-top-right">
                            @if (Game.TeamFormat == TeamFormat.Pairs)
                            {
                                <div class="pill pill-dark">@m.Team2.Single().Name</div>
                            }
                            else
                            {
                                var names2 = IndividualNames(m.Team2).ToArray();
                                <div class="stack">
                                    <div class="pill pill-dark pill-sm">@names2[0]</div>
                                </div>
                            }
                        </div>

                        <!-- MID (SCORES) -->
                        <div class="disc grid-mid-left"
                             role="button" tabindex="0"
                             @onclick="@(async () => await _scorePicker.ShowAsync(m, 1, Game.ToPoints))"
                             @onkeyup="@(async e => { if (e.Key == "Enter") await _scorePicker.ShowAsync(m, 1, Game.ToPoints); })">
                            @(m.Team1Points.HasValue ? m.Team1Points.Value.ToString() : "?")
                        </div>

                        <div class="disc grid-mid-right"
                             role="button" tabindex="0"
                             @onclick="@(async () => await _scorePicker.ShowAsync(m, 2, Game.ToPoints))"
                             @onkeyup="@(async e => { if (e.Key == "Enter") await _scorePicker.ShowAsync(m, 2, Game.ToPoints); })">
                            @(m.Team2Points.HasValue ? m.Team2Points.Value.ToString() : "?")
                        </div>

                        <!-- BOTTOM LEFT -->
                                
                        @if (Game.TeamFormat == TeamFormat.Individual)
                        {
                            <div class="grid-bot-left">
                                @{
                                    var names1 = IndividualNames(m.Team1).ToArray();
                                    <div class="stack">
                                        <div class="pill pill-dark pill-sm">@names1[1]</div>
                                    </div>
                                }
                            </div>

                            <!-- BOTTOM RIGHT -->
                            <div class="grid-bot-right">
                                @{
                                    var names2 = IndividualNames(m.Team2).ToArray();
                                    <div class="stack">
                                        <div class="pill pill-dark pill-sm">@names2[1]</div>
                                    </div>
                                }
                            </div>
                        }
                    </div>
                </div>
            </div>
        }
    </div>
}

        <div class="d-flex justify-content-center my-4 gap-2">
            <Button Color="ButtonColor.Primary"
                    Disabled="@(!CanGoNext)"
                    @onclick="NextRound">
                ‚ñ∂ Next
            </Button>

            <Button Color="ButtonColor.Warning"
                    Disabled="@(!CanGoFinal || !CanGoNext)"
                    @onclick="FinalRound">
                üèÅ Final round
            </Button>
        </div>
</div>

</div>

<ScorePicker @ref="_scorePicker" OnPick="OnScorePicked" />

@code {
    private ScorePicker _scorePicker = default!;
    private Game Game { get; set; } = new();

    // Radio bindings (map bool <-> string for Blazor.Bootstrap RadioInput)
    private bool IsAmericano { get => Game.TournamentType == TournamentType.Americano; set { if (value) Game.TournamentType = TournamentType.Americano; } }
    private bool IsMexicano { get => Game.TournamentType == TournamentType.Mexicano; set { if (value) Game.TournamentType = TournamentType.Mexicano; } }

    private bool IsPointsThenWins { get => Game.ResultSorting == ResultSorting.PointsOverWins; set { if (value) Game.ResultSorting = ResultSorting.PointsOverWins; } }
    private bool IsWinsThenPoints { get => Game.ResultSorting == ResultSorting.WinsOverPoints; set { if (value) Game.ResultSorting = ResultSorting.WinsOverPoints; } }

    private bool IsPlayPointsOrGames { get => Game.ScoringType == ScoringType.GamesAndSets; set { if (value) Game.ScoringType = ScoringType.GamesAndSets; } }
    private bool IsPlayToPoints { get => Game.ScoringType == ScoringType.Points; set { if (value) Game.ScoringType = ScoringType.Points; } }

    private bool IsIndividual { get => Game.TeamFormat == TeamFormat.Individual; set { if (value) Game.TeamFormat = TeamFormat.Individual; } }
    private bool IsTeam { get => Game.TeamFormat == TeamFormat.Pairs; set { if (value) Game.TeamFormat = TeamFormat.Pairs; } }

    private string? NewCourtName { get; set; }
    private string? NewPlayerName { get; set; }
    
    bool ShowMatches => Game.Matches.Any();

    protected override void OnInitialized()
    {
        base.OnInitialized();
        Game.Courts = [new Court("Court 1", 1), new Court("Court 2", 2)];
        Game.Players = [new Player("Dominik P", 1), new Player("Hajzen", 2), new Player("Hubert", 3), new Player("Pan Krzysztof", 4),];
    }

    void AddCourt()
    {
        var name = (NewCourtName ?? string.Empty).Trim();
        if (!string.IsNullOrWhiteSpace(name))
        {
            Game.Courts.Add(new Court(name, Game.Courts.Count + 1));
            NewCourtName = string.Empty;
        }
    }

    void RemoveCourtByOrder(int order)
    {
        var found = Game.Courts.FirstOrDefault(x => x.Order == order);
        if (found is not null)
        {
            Game.Courts.Remove(found);
        }
        ReindexCourts(order);
    }

    void EditCourtByOrder(int order)
    {
        var c = Game.Courts.FirstOrDefault(x => x.Order == order);
        if (c is null)
        {
            return;
        }
        c.EditName = c.Name;
        c.IsEditing = true;
    }

    void SaveCourt(int order)
    {
        var c = Game.Courts.FirstOrDefault(x => x.Order == order);
        if (c is null)
        {
            return;
        }
        var newName = c.EditName?.Trim() ?? c.Name;
        if (!string.IsNullOrWhiteSpace(newName)) c.Name = newName;
        c.IsEditing = false;
        c.EditName = null;
        ReindexPlayers();
    }

    void CancelEditCourt(int order)
    {
        var c = Game.Courts.FirstOrDefault(x => x.Order == order);
        if (c is null)
        {
            return;
        }
        c.IsEditing = false;
        c.EditName = null;
    }

    void ReindexCourts(int order)
    {
        for (var i = order; i < Game.Courts.Count; i++)
        {
            Game.Courts[i].Order = i + 1;
        }
    }

    void AddPlayer()
    {
        var name = (NewPlayerName ?? string.Empty).Trim();
        if (!string.IsNullOrWhiteSpace(name))
        {
            Game.Players.Add(new Player(name, Game.Players.Count + 1));
            NewPlayerName = string.Empty;
        }
        ReindexPlayers();
    }

    void EditPlayer(string name)
    {
        var p = Game.Players.FirstOrDefault(x => x.Name == name);
        if (p is null)
        {
            return;
        }
        p.EditName = p.Name;
        p.IsEditing = true;
    }

    void SavePlayer(string name)
    {
        var p = Game.Players.FirstOrDefault(x => x.Name == name);
        if (p is null)
        {
            return;
        }
        var newName = p.EditName?.Trim() ?? p.Name;
        if (!string.IsNullOrWhiteSpace(newName)) p.Name = newName;
        p.IsEditing = false;
        p.EditName = null;
        ReindexPlayers();
    }

    void CancelEditPlayer(string name)
    {
        var p = Game.Players.FirstOrDefault(x => x.Name == name);
        if (p is null)
        {
            return;
        }
        p.IsEditing = false;
        p.EditName = null;
    }

    void RemovePlayerById(string name)
    {
        var found = Game.Players.FirstOrDefault(x => x.Name == name);
        if (found is not null) Game.Players.Remove(found);
        ReindexPlayers();
    }

    void ReindexPlayers()
    {
        for (var i = 0; i < Game.Players.Count; i++)
        {
            Game.Players[i].Order = i + 1;
        }
    }

    void OnEnterUp(KeyboardEventArgs e, Action action)
    {
        if (e.Key == "Enter") action();
    }

    void NextRound()
    {
        // If there are current matches, require completion and commit them first
        if (Game.Matches.Count > 0)
        {
            if (!AllScoresFilled())
                return; // guard: shouldn't be clickable, but double-protect

            CommitCurrentRound();
        }

        // Generate the next round (keep your actual Americano/Mexicano logic here)
        GenerateNextRoundMatches();

        Game.CurrentRound++;
        StateHasChanged();
    }

    void GenerateNextRoundMatches()
    {
        Game.Matches.Clear();

        // Shuffle (replace with Americano/Mexicano pairing later)
        var pool = Game.Players.OrderBy(_ => Guid.NewGuid()).ToList();
        int p = 0;

        foreach (var court in Game.Courts)
        {
            var m = new Match
            {
                Round = Game.CurrentRound,
                CourtName = court.Name
            };

            if (Game.TeamFormat == TeamFormat.Pairs)
            {
                if (p + 1 >= pool.Count) break;

                m.Team1.Add(pool[p++]); // one player
                m.Team2.Add(pool[p++]); // one player
            }
            else
            {
                if (p + 3 >= pool.Count) break;

                m.Team1.Add(pool[p++]);
                m.Team1.Add(pool[p++]);

                m.Team2.Add(pool[p++]);
                m.Team2.Add(pool[p++]);
            }

            Game.Matches.Add(m);
        }
    }

    void CommitCurrentRound()
    {
        foreach (var m in Game.Matches)
        {
            // Push to history for each player
            foreach (var p in m.Team1) p.MatchHistory.Add(m);
            foreach (var p in m.Team2) p.MatchHistory.Add(m);

            // Update per-player stats
            foreach (var p in m.Team1) p.Points += m.Team1Points.Value;
            foreach (var p in m.Team2) p.Points += m.Team2Points.Value;

            if (m.Team1Points > m.Team2Points)
                foreach (var p in m.Team1) p.Wins += 1;
            else if (m.Team2Points > m.Team1Points)
                foreach (var p in m.Team2) p.Wins += 1;
            // ties => no Wins increment
        }

        // Optional: persist/clear the on-screen matches after commit
        Game.Matches.Clear();
    }

    IEnumerable<string> IndividualNames(List<Player> team)
    {
        return team.Count switch
        {
            0 => new[] { "?", "?" },
            1 => new[] { team[0].Name, "?" },
            _ => new[] { team[0].Name, team[1].Name }
        };
    }

    private void OnScorePicked(ScorePicker.ScorePickArgs e)
    {
        var max = Math.Max(0, Game.ToPoints);
        var other = max - e.Selected;

        if (e.Team == 1)
        {
            e.Match.Team1Points = e.Selected;
            e.Match.Team2Points = other;
        }
        else
        {
            e.Match.Team2Points = e.Selected;
            e.Match.Team1Points = other;
        }

        StateHasChanged();
    }

    void FinalRound()
    {
        // Commit the current visible round (push to histories & update stats)
        if (Game.Matches.Count > 0)
        {
            if (!AllScoresFilled()) return; // safety
            CommitCurrentRound();
        }

        // Build the final pairing(s)
        GenerateFinalRoundMatches();

        // Optional: mark round name/number
        Game.CurrentRound++;
        StateHasChanged();
    }

    void GenerateFinalRoundMatches()
    {
        Game.Matches.Clear();

        // Rank players for finals according to your standings rule
        var ranked = OrderPlayersForFinal(Game.Players).ToList();
        if (ranked.Count < 4) return;

        if (Game.TeamFormat == TeamFormat.Individual)
        {
            // One showcase doubles final on the first court using top 4 and selected option
            var court = Game.Courts.First();

            var (t1, t2) = Game.FinalPairingOption switch
            {
                FinalPairingOption.OneTwoVsThreeFour => (new[] { ranked[0], ranked[1] }, new[] { ranked[2], ranked[3] }),
                FinalPairingOption.OneFourVsTwoThree => (new[] { ranked[0], ranked[3] }, new[] { ranked[1], ranked[2] }),
                FinalPairingOption.OneThreeVsTwoFour => (new[] { ranked[0], ranked[2] }, new[] { ranked[1], ranked[3] }),
                _ => (new[] { ranked[0], ranked[1] }, new[] { ranked[2], ranked[3] })
            };

            var m = new Match { Round = Game.CurrentRound, CourtName = court.Name };
            m.Team1.AddRange(t1);
            m.Team2.AddRange(t2);
            Game.Matches.Add(m);
        }
        else // TeamFormat.Pairs
        {
            var block = 0;
            for (var c = 0; c < Game.Courts.Count; c++)
            {
                var i = block * 2;
                if (i + 2 >= ranked.Count) break;

                var m = new Match { Round = Game.CurrentRound, CourtName = Game.Courts[c].Name };
                m.Team1.Add(ranked[i + 0]);
                m.Team2.Add(ranked[i + 1]);

                Game.Matches.Add(m);
                block++;
            }
        }
    }

    IEnumerable<Player> OrderPlayersForFinal(IEnumerable<Player> players)
    {
        return Game.ResultSorting switch
        {
            ResultSorting.WinsOverPoints =>
                players.OrderByDescending(p => p.Wins)
                    .ThenByDescending(p => p.Points)
                    .ThenBy(p => p.Order)
                    .ThenBy(p => p.Name),

            ResultSorting.PointsOverWins =>
                players.OrderByDescending(p => p.Points)
                    .ThenByDescending(p => p.Wins)
                    .ThenBy(p => p.Order)
                    .ThenBy(p => p.Name),

            _ =>
                players.OrderByDescending(p => p.Points)
                    .ThenByDescending(p => p.Wins)
                    .ThenBy(p => p.Order)
                    .ThenBy(p => p.Name)
        };
    }

    bool AllScoresFilled()
        => Game.Matches.All(m => (m.Team1Points + m.Team2Points) == Game.ToPoints);

    bool BaseReady()
        => Game.Courts.Count >= 1 && Game.Players.Count >= 4;

    bool CanGoNext
        => BaseReady() && (Game.Matches.Count == 0 || AllScoresFilled());

    bool CanGoFinal
        => CanGoNext && Game.Matches.Count > 0;
}
